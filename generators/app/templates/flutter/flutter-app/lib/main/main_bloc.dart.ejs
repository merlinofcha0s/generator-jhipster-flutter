import 'dart:async';

<%_ if (enableTranslation) { _%>
import 'package:flutter/widgets.dart';
import 'package:<%= baseName %>/generated/l10n.dart';
<%_ } _%>
import 'package:<%= baseName %>/shared/bloc/bloc.dart';
import 'package:<%= baseName %>/shared/models/user.dart';
import 'package:<%= baseName %>/shared/repository/account_repository.dart';
import 'package:rxdart/rxdart.dart';

class MainBloc extends Bloc {
  final _user = BehaviorSubject<User>();

  Stream<User> get userStream => _user.stream;

  final accountRepository = AccountRepository();

  User currentUser;

  MainBloc();

  Future<User> fetchConnectedUser() async {
    if(currentUser == null) {
      currentUser = await accountRepository.getIdentity();
      _user.sink.add(currentUser);
    }
    return currentUser;
  }

  <%_ if (enableTranslation) { _%>
  Future<bool> init() async {
    await fetchConnectedUser();
    return await detectLanguage();
  }
  <%_ } else { _%>
  void init() async {
    await fetchConnectedUser();
  }
  <%_ } _%>

  <%_ if (enableTranslation) { _%>
  Future<bool> detectLanguage() async {
     bool reload = false;
     if(currentUser.langKey.compareTo(S.current.locale) != 0) {
        S.load(Locale(currentUser.langKey));
        reload = true;
     }
     return reload;
  }
  <%_ } _%>

  @override
  void dispose() => () {
    _user.close();
  };
}
